<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> chrome plugin message passing · code and eat and drink and life</title><meta name="description" content="chrome plugin message passing - YL"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://lycworks.me/blog/atom.xml" title="code and eat and drink and life"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/blog/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="http://lycworks.me" target="_blank" class="nav-list-link">WEBSITE</a></li><li class="nav-list-item"><a href="https://github.com/ylu021" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">chrome plugin message passing</h1><div class="post-info">Feb 10, 2017</div><div class="post-content"><h1 id="notice-For-self-learning-purpose"><a href="#notice-For-self-learning-purpose" class="headerlink" title="notice: For self learning purpose"></a>notice: For self learning purpose</h1><p>what this does not talk about is the general setup, in this article, only brief messaging method is mentioned</p>
<blockquote>
<p>please note i’m using page action for this example</p>
</blockquote>
<h3 id="first-of-all-the-structure"><a href="#first-of-all-the-structure" class="headerlink" title="first of all the structure"></a>first of all the structure</h3><p><code>manifest.json</code> settings</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&quot;background&quot; : &#123;</div><div class="line">    &quot;scripts&quot;: [&quot;background.js&quot;],</div><div class="line">    &quot;persistent&quot;: false</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">&quot;page_action&quot; :</div><div class="line">&#123;</div><div class="line">  &quot;default_icon&quot; : &quot;video-19.png&quot;,</div><div class="line">  &quot;default_title&quot; : &quot;There&apos;s a &lt;video&gt; in this page!&quot;,</div><div class="line">  &quot;default_popup&quot;: &quot;popup.html&quot;</div><div class="line">&#125;,</div><div class="line"></div><div class="line">&quot;permissions&quot;: [</div><div class="line">  &quot;declarativeContent&quot;,</div><div class="line">  &quot;tabs&quot;,</div><div class="line">  &quot;http://*/&quot;,</div><div class="line">  &quot;https://*/&quot;</div><div class="line">],</div><div class="line"></div><div class="line">&quot;content_scripts&quot;: [</div><div class="line">  &#123;</div><div class="line">    &quot;matches&quot;: [&quot;http://*/*&quot;],</div><div class="line">    &quot;js&quot;: [</div><div class="line">      &quot;contentscript.js&quot;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">],</div></pre></td></tr></table></figure>
<p><code>background.js</code> settings</p>
<p>what is background? the file that exist even after refreshing pages, purpose is to talk to page dom and contentscript, act as the MVC’s controller</p>
<p><code>popup.js</code> the extension’s javascript page, to illustrate the purpose, popup.html is also created which looks like this</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;div id=&quot;mainPopup&quot;&gt;</div><div class="line">&lt;h1&gt;Hello extensionizr!&lt;/h1&gt;</div><div class="line">&lt;p&gt;I can add stuff here i suppose, and I can retrive content from the page&lt;/p&gt;</div><div class="line">&lt;div id=&quot;message&quot;&gt;&lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;script src=&apos;popup.js&apos;&gt;&lt;/script&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>the only important thing to know is the last line <code>script</code></p>
</blockquote>
<p><code>contentscript.js</code> how one can obtain the chrome current tab’s page’s DOM and its elements</p>
<p>for example, one can do <code>document.querySelector(&#39;video&#39;)</code></p>
<h3 id="Some-page-setup-for-specific-usage"><a href="#Some-page-setup-for-specific-usage" class="headerlink" title="Some page setup for specific usage"></a>Some page setup for specific usage</h3><p>before moving on to messaging, let me rephrase the definition of browser_action and page_action.</p>
<p><code>browser_action</code> is when the extension is visible on every page.<br><code>page_action</code> is when the extension is only activated at current page.</p>
<p>Ok, so our goal is to only show the extension when the page has a video. How to achieve that is through <code>declarativeContent</code>. For more details visit <a href="https://developer.chrome.com/extensions/declarativeContent" target="_blank" rel="external">url</a>.</p>
<blockquote>
<p>The best part about <code>declarativeContent</code> is “one can read the page’s content without requiring permission to do so”</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">chrome.runtime.onInstalled.addListener(function() &#123;</div><div class="line">  chrome.declarativeContent.onPageChanged.removeRules(undefined, function() &#123;</div><div class="line">    chrome.declarativeContent.onPageChanged.addRules([&#123;</div><div class="line">      conditions: [</div><div class="line">        // When a page contains a &lt;video&gt; tag...</div><div class="line">        new chrome.declarativeContent.PageStateMatcher(&#123;</div><div class="line">          css: [&quot;video&quot;]</div><div class="line">        &#125;)</div><div class="line">      ],</div><div class="line">      // ... show the page action.</div><div class="line">      actions: [new chrome.declarativeContent.ShowPageAction() ] //cause page action button to be shown</div><div class="line">    &#125;]);</div><div class="line">  &#125;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>up to here our extension pretty much looks like <a href="https://developer.chrome.com/extensions/samples#search:page%20action%20by%20content" target="_blank" rel="external">page action by content</a> provided by Google’s api.</p>
<h3 id="Now-let’s-try-One-time-messaging"><a href="#Now-let’s-try-One-time-messaging" class="headerlink" title="Now let’s try One time messaging"></a>Now let’s try One time messaging</h3><p>Our goal is to get continuous communication which uses a <code>port</code>, however, to understand the logic first, I propose trying out this example.</p>
<p>So in this example, our goal is to retrieve the video’s information from the current page. That involves two steps for our page_action (and obviously for browser and storage purpose, we would want to pass to background first, but this is just a simple example so)</p>
<ol>
<li>sending a request from extension to contentscript</li>
<li>in contentscript, send the video content back to extension</li>
</ol>
<blockquote>
<p>extension here means <code>popup.js</code>, which contains our extension setups and methods</p>
</blockquote>
<p>Let’s do this!</p>
<p>First, in <code>popup.js</code>, we use current tab’s callback to do the messaging</p>
<blockquote>
<p>how to get current tab? <a href="https://developer.chrome.com/extensions/tabs" target="_blank" rel="external">documentation</a> or check out the code below</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chrome.tabs.query(&#123; currentWindow: true, active: true &#125;, function(tabs) &#123;</div><div class="line">  console.log(&apos;current tab is&apos;+ tabs[0].id)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Within this callback function, we use executeScript to communicate to <code>contentscript.js</code>.</p>
<blockquote>
<p>After doing a lot of research, I discovered this step is often not explained in the documentations and others example, if anyone has any idea why this line is necessary please leave a comment and share your understanding</p>
</blockquote>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> chrome.tabs.executeScript(null,&#123; //null defaults to current tab</div><div class="line">          file: &apos;contentscript.js&apos;</div><div class="line">        &#125;, function() &#123;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>Within the executeScript’s callabck function, we use <code>chrome.tabs.sendMessage</code> to request</p>
<blockquote>
<p>in background and contentscript, we use chrome.runtime.sendMessage, to understand the diff, I recommending reading this <a href="http://stackoverflow.com/questions/41420528/communicate-between-scripts-in-the-background-context-background-script-browse" target="_blank" rel="external">stackoverflow</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chrome.tabs.sendMessage( tabs[0].id, &#123; greeting: &apos;hello from the page action~&apos; &#125;, function(res) &#123;</div><div class="line">  if(res)&#123; //blabla&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<blockquote>
<p>res here is whatever received from contentscript, which will be explained next</p>
</blockquote>
<p>In <code>contentscript.js</code>, listens using <code>onMessage</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">chrome.runtime.onMessage.addListener(function(msg, sender, sendResponse) &#123;</div><div class="line">  if(msg.greeting)</div><div class="line">    console.log(&apos;i got the messge&apos;, msg.greeting)</div><div class="line">    //sendResponse</div><div class="line">    sendResponse(&#123;</div><div class="line">      reply: &apos;yehyeh&apos;,</div><div class="line">      ispaused: document.querySelector（&apos;video&apos;).paused //boolean</div><div class="line">    &#125;)</div><div class="line">    return true</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p><code>sendResponse</code> is a callback works like <code>sendMessage</code>, which sends the dom element attribute as a json object to extension.</p>
<p>Now back to extension, use <code>ctrl+f</code> search for <code>blabla</code>, this is where you can check response by console log <code>res.reply, res.ispaused</code>.</p>
<h1 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a>Foreword</h1><p>That’s it! You should now able to get the video info from the extension. Check popup inspector and page inspector for console. If you have any question or suggestion, please leave a comment below.</p>
</div><div><label>Tags:</label><a href="/blog/tags/chrome/">#chrome</a></div></article></div></main><footer><div class="paginator"><a href="/blog/2017/02/14/jquery-and-react/" class="prev">上一篇</a><a href="/blog/2017/02/08/2017-02-01-matrix/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'https-ylu021-github-io-blog';
var disqus_identifier = '2017/02/10/chrome-plugin-message/';
var disqus_title = 'chrome plugin message passing';
var disqus_url = 'http://lycworks.me/blog/2017/02/10/chrome-plugin-message/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//https-ylu021-github-io-blog.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 <a href="http://lycworks.me/blog">YL</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-71046273-3",'auto');ga('send','pageview');</script></body></html>